<!--
Copyright 2017 Next Century Corporation

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<link rel="import" href="../date-range-facet/date-range-facet.html">
<link rel="import" href="../facet-list/facet-list.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../lodash-import/lodash.html">
<link rel="import" href="../paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../paper-header-panel/paper-header-panel.html">
<link rel="import" href="../paper-toolbar/paper-toolbar.html">
<link rel="import" href="../selected-facets-display/selected-facets-display.html">

<!--
A Polymer Element containing a group of facet-lists and date-range-facets.

### Example
```html
<facet-panel
  facets-query="[[facetsQuery]]"
  search-keys="[[searchKeys]]"
  process-request="{{processRequest}}"
  search-endpoint="[[searchEndpoint]]"
  search-fields="[[searchFields]]"
  search-parameters="{{searchParameters}}">
</facet-panel>
```

### Styling

`<facet-panel>` provides the following custom properties and mixins for styling:

Custom property                                 | Description                                  | Default
------------------------------------------------|----------------------------------------------|--------
`--facet-panel-selected-facet-background-color` | The background color of the selected facets. | gray
`--facet-panel-selected-facet-icon-hover-color` | The icon hover color of the selected facets. | white
`--facet-panel-selected-facet-text-color`       | The text color of the selected facets.       | black

@demo demo/index.html
-->

<dom-module id="facet-panel">
  <template>
    <style include="iron-flex iron-flex-alignment"></style>

    <style>
      .facets {
        padding: 20px;
      }

      .expand-collapse-all {
        cursor: pointer;
        font-weight: 500;
        line-height: 24px;
      }

      date-range-facet ::slotted(iron-collapse) {
        margin-bottom: 40px;
      }

      date-range-facet,
      facet-list {
        margin: 10px 0;
      }

      paper-toolbar {
        --paper-toolbar-height: auto;
        --paper-toolbar-content: {
          padding: 0;
        };
        background: inherit;
        color: inherit;
        max-height: 240px;
        overflow-y: auto;
        padding: 20px;
      }

      .selected-facets-header {
        font-weight: 500;
        /* Same height as the selected-facet-display components. */
        line-height: 30px;
      }

      selected-facets-display {
        --selected-facet-bg-color: var(--facet-panel-selected-facet-background-color, gray);
        --selected-facet-icon-hover-color: var(--facet-panel-selected-facet-icon-hover-color, white);
        --selected-facet-text-color: var(--facet-panel-selected-facet-text-color, black);
      }

      selected-facets-display {
        --selected-facet-item-style-mixin: {
          border-radius: 3px;
        };
      }
    </style>

    <paper-header-panel>
      <template is="dom-if" if="[[searchParameters]]">
        <paper-toolbar slot="header">
          <div class="layout vertical" slot="top">
            <template is="dom-if" if="[[!_noSearchParameters(searchParameters.*)]]">
              <div class="selected-facets-header">Search Terms</div>
            </template>

            <template is="dom-if" if="[[_noSearchParameters(searchParameters.*)]]">
              <div class="selected-facets-header">No Search Terms</div>
            </template>

            <div class="layout horizontal wrap">
              <template is="dom-repeat" items="[[searchKeys]]">
                <selected-facets-display facet-key="[[item]]" facets="{{searchParameters}}"></selected-facets-display>
              </template>
            </div>
          </div>
        </paper-toolbar>

        <div class="facets">
          <div class="layout horizontal facet expand-collapse-all" title="Toggle All Facets" on-tap="_toggleAllFacetLists">
            <span class="flex">Facets</span>
            <span>[[_getToggleAllFacetsText(collapseFacets)]]</span>
            <iron-icon icon="[[_getToggleAllFacetsIcon(collapseFacetLists)]]"></iron-icon>
          </div>

          <template is="dom-repeat" items="[[searchFields]]">
            <template is="dom-if" if="[[item.facets]]">
              <template is="dom-if" if="[[!_equals(item.type, 'date')]]">
                <facet-list
                  class="facet"
                  query-url="[[searchEndpoint]]"
                  name="[[item.key]]"
                  title="[[item.title]]"
                  target="_blank"
                  result-config="[[_createResultConfig(item.key, networkExpansionParameters.*)]]"
                  result-function="[[item.facetTransform]]"
                  result-list="{{item.results}}"
                  search-config="[[networkExpansionParameters]]"
                  search-function="[[facetsQuery]]"
                  search-parameters-property="[[item.key]]"
                  text-function="[[textFunction]]"
                  search-parameters="{{searchParameters}}"
                  process-request="{{processRequest}}">
                </facet-list>
              </template>

              <template is="dom-if" if="[[_equals(item.type, 'date')]]">
                <date-range-facet
                  class="facet"
                  header-title="[[item.title]]"
                  date-start-key="[[item.dateProperties.start.key]]"
                  date-start-title="[[item.dateProperties.start.title]]"
                  date-end-key="[[item.dateProperties.end.key]]"
                  date-end-title="[[item.dateProperties.end.title]]"
                  search-parameters-property="[[item.key]]"
                  search-parameters="{{searchParameters}}">
                </date-range-facet>
              </template>
            </template>
          </template>

          <slot></slot>
        </div>
      </template>
    </paper-header-panel>
  </template>

  <script>
    (function () {
      'use strict';

      Polymer({
        is: 'facet-panel',

        properties: {
          /**
           * (Optional)
           *
           * Whether or not to collapse the facet lists.
           *
           * @type {Boolean}
           * @default false
           */
          collapseFacetLists: {
            type: Boolean,
            value: false
          },

          /**
           * (Required)
           *
           * The query used by the facets.
           *
           * @type {Object}
           */
          facetsQuery: {
            type: Object
          },

          /**
           * (Required)
           *
           * The network expansion parameters used by the facets.
           *
           * @type {Object}
           */
          networkExpansionParameters: {
            type: Object
          },

          /**
           * (Required|Output)
           *
           * The request object used by querys.
           *
           * @type {Object}
           */
          processRequest: {
            notify: true,
            type: Object
          },

          /**
           * (Required)
           *
           * The search endpoint used by querys.
           *
           * @type {Object}
           */
          searchEndpoint: {
            type: Object
          },

          /**
           * (Required)
           *
           * The search fields used by the facets.
           *
           * @type {Object}
           */
          searchFields: {
            type: Object
          },

          /**
           * (Required)
           *
           * The search keys used by the facets.
           *
           * @type {Object}
           */
          searchKeys: {
            type: Object
          },

          /**
           * (Required|Output)
           *
           * The search parameters used by the facets.
           *
           * @type {Object}
           */
          searchParameters: {
            notify: true,
            type: Object
          },

          /**
           * (Optional)
           *
           * A function given to the `facet-list` to transform the ID into the text for the object.
           *
           * @type {Function}
           */
          textFunction: {
            type: Object
          },

          /**
           * (Optional)
           *
           * A function that returns whether all the search parameters in the given object are disabled (or empty).
           *
           * @type {Object}
           * @default function
           */
          areSearchParametersDisabled: {
            type: Object,
            value: function() {
              return function(searchParameters) {
                return _.keys(searchParameters).every(function(type) {
                  if(_.isEmpty(searchParameters[type])) {
                    return true;
                  }
                  return _.keys(searchParameters[type]).every(function(term) {
                    return !searchParameters[type][term].enabled;
                  });
                });
              };
            }
          }
        },

        /**
         * Creates and returns the result config for the facet list using the networkExpansionParameters and the given name.
         *
         * @param {String} name
         * @return {Object}
         * @private
         */
        _createResultConfig: function(name) {
          return {
            name: name,
            isNetworkExpansion: !!(_.findKey(this.networkExpansionParameters || {}, function(key) {
              return key;
            }))
          };
        },

        _toggleAllFacetLists: function() {
          var self = this;
          self.collapseFacetLists = !self.collapseFacetLists;
          // All facet lists should have the class 'facet'
          var allFacetListNames = Polymer.dom(this.root).querySelectorAll('.facet');

          for (var i = 0, length = allFacetListNames.length; i < length; i++) {
            allFacetListNames[i].opened = !self.collapseFacetLists;
          }
        },

        _getToggleAllFacetsText: function() {
          return (this.collapseFacetLists ? 'Expand' : 'Collapse') + ' All';
        },

        _getToggleAllFacetsIcon: function() {
          return (this.collapseFacetLists ? 'icons:expand-more' : 'icons:expand-less');
        },

        _noSearchParameters: function() {
          return this.areSearchParametersDisabled(this.searchParameters);
        },

        _equals: function(a, b) {
          return a === b;
        }
      });
    })();
  </script>
</dom-module>
